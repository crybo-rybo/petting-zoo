openapi: 3.1.0
info:
  title: Petting Zoo API (MVP)
  version: 0.2.0
  summary: Minimal API for local model loading and chat.
  description: |
    MVP reset contract for the Petting Zoo application server.
    Scope includes health, model registration/selection, and synchronous chat.
servers:
  - url: http://localhost:8080
    description: Local development server
tags:
  - name: Health
  - name: Models
  - name: Chat
paths:
  /healthz:
    get:
      tags: [Health]
      summary: Liveness and version health check
      operationId: getHealth
      responses:
        '200':
          description: Service is healthy
          headers:
            X-Correlation-Id:
              $ref: '#/components/headers/XCorrelationId'
          content:
            application/json:
              schema:
                type: object
                required: [status, service, version, timestamp]
                properties:
                  status:
                    type: string
                    const: ok
                  service:
                    type: string
                    example: petting-zoo-server
                  version:
                    type: string
                    example: 0.2.0
                  timestamp:
                    type: string
                    format: date-time
  /api/models:
    get:
      tags: [Models]
      summary: List registered model candidates and currently active model
      operationId: listModels
      parameters:
        - $ref: '#/components/parameters/XCorrelationId'
      responses:
        '200':
          description: Model inventory
          headers:
            X-Correlation-Id:
              $ref: '#/components/headers/XCorrelationId'
          content:
            application/json:
              schema:
                type: object
                required: [models, active_model_id]
                properties:
                  models:
                    type: array
                    items:
                      $ref: '#/components/schemas/ModelSummary'
                  active_model_id:
                    type: string
                    nullable: true
  /api/models/register:
    post:
      tags: [Models]
      summary: Register a local GGUF model path on the server host
      operationId: registerModel
      parameters:
        - $ref: '#/components/parameters/XCorrelationId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ModelRegisterRequest'
      responses:
        '201':
          description: Model registered
          headers:
            X-Correlation-Id:
              $ref: '#/components/headers/XCorrelationId'
          content:
            application/json:
              schema:
                type: object
                required: [model]
                properties:
                  model:
                    $ref: '#/components/schemas/ModelSummary'
        '400':
          $ref: '#/components/responses/BadRequest'
  /api/models/select:
    post:
      tags: [Models]
      summary: Set active model used for chat requests
      operationId: selectModel
      parameters:
        - $ref: '#/components/parameters/XCorrelationId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ModelSelectRequest'
      responses:
        '200':
          description: Active model updated
          headers:
            X-Correlation-Id:
              $ref: '#/components/headers/XCorrelationId'
          content:
            application/json:
              schema:
                type: object
                required: [active_model]
                properties:
                  active_model:
                    $ref: '#/components/schemas/ModelSummary'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
  /api/chat/complete:
    post:
      tags: [Chat]
      summary: Send a user message to the active model and wait for completion
      operationId: completeChat
      parameters:
        - $ref: '#/components/parameters/XCorrelationId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatCompleteRequest'
      responses:
        '200':
          description: Completion returned
          headers:
            X-Correlation-Id:
              $ref: '#/components/headers/XCorrelationId'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatCompleteResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'
        '502':
          $ref: '#/components/responses/UpstreamError'
  /api/chat/reset:
    post:
      tags: [Chat]
      summary: Clear conversation history for the active model
      operationId: resetChat
      parameters:
        - $ref: '#/components/parameters/XCorrelationId'
      responses:
        '200':
          description: History cleared
          headers:
            X-Correlation-Id:
              $ref: '#/components/headers/XCorrelationId'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResetResponse'
        '409':
          $ref: '#/components/responses/Conflict'
components:
  parameters:
    XCorrelationId:
      in: header
      name: X-Correlation-Id
      required: false
      schema:
        type: string
      description: Optional request correlation ID. Generated by server when absent.
  headers:
    XCorrelationId:
      description: Correlation ID for tracing request flow.
      schema:
        type: string
  responses:
    BadRequest:
      description: Invalid request
      headers:
        X-Correlation-Id:
          $ref: '#/components/headers/XCorrelationId'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
    NotFound:
      description: Resource not found
      headers:
        X-Correlation-Id:
          $ref: '#/components/headers/XCorrelationId'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
    Conflict:
      description: State conflict
      headers:
        X-Correlation-Id:
          $ref: '#/components/headers/XCorrelationId'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
    UpstreamError:
      description: Upstream runtime error
      headers:
        X-Correlation-Id:
          $ref: '#/components/headers/XCorrelationId'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
  schemas:
    ErrorEnvelope:
      type: object
      required: [error]
      properties:
        error:
          type: object
          required: [code, category, message, retryable, correlation_id]
          properties:
            code:
              type: string
              example: APP-VAL-001
            category:
              type: string
              enum: [validation, auth, not_found, conflict, rate_limit, timeout, upstream, internal]
            message:
              type: string
            retryable:
              type: boolean
            correlation_id:
              type: string
            details:
              type: object
              additionalProperties: true
    ModelSummary:
      type: object
      required: [id, display_name, path, status, context_size]
      properties:
        id:
          type: string
        display_name:
          type: string
        path:
          type: string
        status:
          type: string
          enum: [available, loading, unavailable]
        context_size:
          type: integer
          minimum: 1
    ModelRegisterRequest:
      type: object
      required: [path]
      properties:
        path:
          type: string
          description: Absolute path to GGUF model file on server host.
        display_name:
          type: string
    ModelSelectRequest:
      type: object
      required: [model_id]
      properties:
        model_id:
          type: string
    ChatCompleteRequest:
      type: object
      required: [message]
      properties:
        message:
          type: string
          minLength: 1
    Usage:
      type: object
      required: [prompt_tokens, completion_tokens, total_tokens]
      properties:
        prompt_tokens:
          type: integer
          minimum: 0
        completion_tokens:
          type: integer
          minimum: 0
        total_tokens:
          type: integer
          minimum: 0
    Metrics:
      type: object
      required: [latency_ms, time_to_first_token_ms, tokens_per_second]
      properties:
        latency_ms:
          type: integer
          minimum: 0
        time_to_first_token_ms:
          type: integer
          minimum: 0
        tokens_per_second:
          type: number
          minimum: 0
    ChatCompleteResponse:
      type: object
      required: [text, usage, metrics]
      properties:
        text:
          type: string
        usage:
          $ref: '#/components/schemas/Usage'
        metrics:
          $ref: '#/components/schemas/Metrics'
    ChatResetResponse:
      type: object
      required: [status, model_id]
      properties:
        status:
          type: string
          const: cleared
        model_id:
          type: string
